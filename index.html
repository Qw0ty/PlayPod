<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ìŒì•… ì¶”ì²œ ì œë³´</title>
  <style>
    body{font-family:system-ui,-apple-system,Arial,sans-serif;margin:24px;line-height:1.45}
    .card{max-width:760px;border:1px solid #e5e5e5;border-radius:12px;padding:16px}
    label{display:block;margin-top:12px;font-weight:800}
    input,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid #d6d6d6;border-radius:10px;margin-top:6px}
    button{margin-top:14px;padding:10px 14px;border:0;border-radius:10px;font-weight:900;cursor:pointer}
    .row{display:flex;gap:12px}
    .row>div{flex:1}
    .preview{margin-top:14px;padding:12px;border-radius:12px;background:#fafafa;border:1px dashed #ddd;display:none}
    .preview img{max-width:220px;border-radius:10px;margin-top:8px}
    .status{margin-top:12px;font-weight:900}
    .muted{color:#666;font-weight:600}
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin:0 0 8px 0;">ğŸ§ ìŒì•… ì¶”ì²œ ì œë³´</h1>
    <p class="muted" style="margin:0 0 12px 0;">ë§í¬ + êµ¬ê°„ì„ ì…ë ¥í•˜ë©´ ìš´ì˜ì ë©”ì¼ë¡œ ì „ì†¡ë¼ìš”.</p>

    <!-- âœ… ì—¬ê¸° actionë§Œ Formspree endpointë¡œ ë°”ê¾¸ì„¸ìš” -->
    <form id="form" method="POST" action="https://formspree.io/f/mlggjprl">
      <label>ìŒì•… ë§í¬</label>
      <input id="url" name="music_url" placeholder="YouTube / Spotify / SoundCloud ë§í¬" required />

      <div class="row">
        <div>
          <label>ì‹œì‘ ì‹œê°„</label>
          <input id="start" name="start_time" placeholder="ì˜ˆ: 1:12 ë˜ëŠ” 00:01:12" required />
        </div>
        <div>
          <label>ë ì‹œê°„</label>
          <input id="end" name="end_time" placeholder="ì˜ˆ: 1:45 ë˜ëŠ” 00:01:45" required />
        </div>
      </div>

      <label>ë©”ëª¨(ì„ íƒ)</label>
      <textarea id="note" name="note" rows="3" placeholder="ì›í•˜ëŠ” ë¶„ìœ„ê¸°/ì°¸ê³ ì‚¬í•­"></textarea>

      <button type="button" id="btnPreview">ë¯¸ë¦¬ë³´ê¸°</button>
      <button type="submit">ì „ì†¡í•˜ê¸°</button>

      <div id="preview" class="preview"></div>
      <div id="status" class="status"></div>

      <!-- âœ… ë¯¸ë¦¬ë³´ê¸° ë©”íƒ€ë¥¼ ê°™ì´ ë©”ì¼ë¡œ ë³´ë‚´ê¸° ìœ„í•œ hidden í•„ë“œ -->
      <input type="hidden" name="meta_provider" id="meta_provider">
      <input type="hidden" name="meta_title" id="meta_title">
      <input type="hidden" name="meta_author" id="meta_author">
      <input type="hidden" name="meta_thumbnail" id="meta_thumbnail">
    </form>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, ok=true){
      $("status").textContent = msg || "";
      $("status").style.color = ok ? "inherit" : "crimson";
    }

    function detectProvider(url){
      try{
        const u = new URL(url);
        const h = u.hostname.toLowerCase();
        if (h.includes("youtube.com") || h.includes("youtu.be")) return "youtube";
        if (h.includes("open.spotify.com") || h.includes("spotify.link")) return "spotify";
        if (h.includes("soundcloud.com")) return "soundcloud";
        return "unknown";
      }catch(e){
        return "invalid";
      }
    }

    function oembedEndpoint(provider, url){
      const encoded = encodeURIComponent(url);
      if (provider === "youtube") return `https://www.youtube.com/oembed?url=${encoded}&format=json`;
      if (provider === "spotify") return `https://open.spotify.com/oembed?url=${encoded}`;
      if (provider === "soundcloud") return `https://soundcloud.com/oembed?format=json&url=${encoded}`;
      return null;
    }

    function renderPreview({ok, title, author_name, provider_name, thumbnail_url, error}){
      const box = $("preview");
      box.style.display = "block";

      if(!ok){
        box.innerHTML = `ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš” ğŸ˜¿<div class="muted">${error || ""}</div>`;
        // ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨í•´ë„ ì „ì†¡ì€ ê°€ëŠ¥
        $("meta_provider").value = "";
        $("meta_title").value = "";
        $("meta_author").value = "";
        $("meta_thumbnail").value = "";
        return;
      }

      box.innerHTML = `
        <div><b>${title || "(ì œëª© ì—†ìŒ)"}</b></div>
        <div class="muted">${provider_name || ""}${author_name ? " Â· " + author_name : ""}</div>
        ${thumbnail_url ? `<img src="${thumbnail_url}" alt="thumbnail">` : ""}
      `;

      // hidden í•„ë“œì— ë‹´ì•„ ë©”ì¼ë¡œ ê°™ì´ ì „ì†¡
      $("meta_provider").value = provider_name || "";
      $("meta_title").value = title || "";
      $("meta_author").value = author_name || "";
      $("meta_thumbnail").value = thumbnail_url || "";
    }

    async function doPreview(){
      const url = $("url").value.trim();
      if(!url){ setStatus("ë§í¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”!", false); return; }

      const provider = detectProvider(url);
      if(provider === "invalid"){ setStatus("URL í˜•ì‹ì´ ì´ìƒí•´ìš” ğŸ˜¿", false); return; }
      if(provider === "unknown"){
        renderPreview({ok:false, error:"ì§€ì›í•˜ì§€ ì•ŠëŠ” ë§í¬ì˜ˆìš”. (YouTube/Spotify/SoundCloud ê¶Œì¥)"});
        setStatus("ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨(ì§€ì› ë§í¬ ì•„ë‹˜) ğŸ˜¿", false);
        return;
      }

      const endpoint = oembedEndpoint(provider, url);
      setStatus("ë¯¸ë¦¬ë³´ê¸° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦");

      try{
        const res = await fetch(endpoint);
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        renderPreview({
          ok:true,
          title: data.title,
          author_name: data.author_name,
          provider_name: data.provider_name,
          thumbnail_url: data.thumbnail_url
        });

        setStatus("ë¯¸ë¦¬ë³´ê¸° ì™„ë£Œ! âœ…");
      }catch(e){
        renderPreview({ok:false, error:"oEmbed í˜¸ì¶œì´ ë§‰í˜”ê±°ë‚˜ ì‹¤íŒ¨í–ˆì–´ìš”(í™˜ê²½ì— ë”°ë¼ CORS ë¬¸ì œ ê°€ëŠ¥). ê·¸ë˜ë„ ì „ì†¡ì€ ë¼ìš”!"});
        setStatus("ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨ ğŸ˜¿", false);
      }
    }

    $("btnPreview").addEventListener("click", doPreview);
    $("url").addEventListener("change", () => { if($("url").value.trim()) doPreview(); });
  </script>
</body>
</html>
